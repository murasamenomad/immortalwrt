name: 'Generate ImmortalWrt Signing Keys (branch: openwrt-24.10)'

on:
  workflow_dispatch: # Allow manual trigger from the Actions tab

jobs:
  generate-keys:
    runs-on: ubuntu-latest

    # 为此作业中的所有 'run' 命令设置默认工作目录
    defaults:
      run:
        working-directory: ./openwrt

    steps:
      - name: 'Install Build Dependencies'
        # 覆盖默认的工作目录设置，因为此时 ./openwrt 目录还不存在。
        # '.' 代表在工作空间的根目录执行此步骤。
        working-directory: .
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git libncurses5-dev libssl-dev ccache

      - name: 'Checkout ImmortalWrt Source on openwrt-24.10 branch'
        uses: actions/checkout@v4
        with:
          repository: 'immortalwrt/immortalwrt'
          ref: 'openwrt-24.10'
          path: 'openwrt' # 此步骤执行后，./openwrt 目录才被创建

      # 后续所有步骤将自动使用 'defaults' 中设置的 ./openwrt 工作目录
      - name: 'Prepare Build Environment'
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          make defconfig

      - name: 'Build Host Tools (including usign)'
        run: |
          make tools/install -j$(nproc) V=s

      - name: 'Generate Key Pair'
        run: |
          ./staging_dir/host/bin/usign -G -p key-build.pub -s key-build
          echo "Signing keys generated successfully in the 'openwrt' directory."

      - name: 'Upload Keys as Artifact'
        # upload-artifact action 默认从根目录开始，所以它的路径不受 'defaults' 影响
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-signing-keys-24.10
          path: |
            openwrt/key-build
            openwrt/key-build.pub
